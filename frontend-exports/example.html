<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorer Protocol - æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .token-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Explorer Protocol æµ‹è¯•é¡µé¢</h1>

        <div class="info">
            <strong>ç½‘ç»œï¼š</strong> OP Sepolia Testnet<br>
            <strong>Chain IDï¼š</strong> 11155420
        </div>

        <div id="wallet-section">
            <h2>é’±åŒ…è¿æ¥</h2>
            <button onclick="connectWallet()" id="connect-btn">è¿æ¥ MetaMask</button>
            <div id="wallet-info" style="display:none;">
                <p><strong>å·²è¿æ¥åœ°å€ï¼š</strong> <span id="address"></span></p>
                <p><strong>ETH ä½™é¢ï¼š</strong> <span id="eth-balance"></span> ETH</p>
            </div>
        </div>

        <div id="token-section" style="display:none;">
            <h2>ä»£å¸ä½™é¢</h2>
            <div class="token-card">
                <h3>POWER Token</h3>
                <p class="balance">ä½™é¢: <span id="power-balance">0</span></p>
                <input type="number" id="power-amount" value="1" min="1" max="1000">
                <button onclick="buyToken(1)">è´­ä¹° POWER (0.0000001 ETH/ä¸ª)</button>
            </div>

            <div class="token-card">
                <h3>OIL Token</h3>
                <p class="balance">ä½™é¢: <span id="oil-balance">0</span></p>
                <input type="number" id="oil-amount" value="1" min="1" max="1000">
                <button onclick="buyToken(2)">è´­ä¹° OIL (0.0000001 ETH/ä¸ª)</button>
            </div>

            <div class="token-card">
                <h3>EXPLORER Token (éœ€è¦ç™½åå•)</h3>
                <p class="balance">ä½™é¢: <span id="explorer-balance">0</span></p>
                <p id="whitelist-status"></p>
                <input type="number" id="explorer-amount" value="1" min="1" max="1000">
                <button onclick="buyToken(3)" id="explorer-buy-btn">è´­ä¹° EXPLORER (0.0000001 ETH/ä¸ª)</button>
            </div>

            <button onclick="refreshBalances()">ğŸ”„ åˆ·æ–°ä½™é¢</button>
        </div>

        <div id="message"></div>
    </div>

    <script type="module">
        // åˆçº¦é…ç½®
        const CONFIG = {
            chainId: 11155420,
            chainIdHex: '0xaa37dc',
            contracts: {
                ExplorerToken: '0x7528A496E0C212fcA3263D272a04309a2330FfC6',
                Minter: '0x26F87856E62f2F72feD55938972684c2C1eFDcC9'
            },
            tokenIds: {
                POWER: 1,
                OIL: 2,
                EXPLORER: 3
            },
            priceWei: '100000000000' // 0.0000001 ETH
        };

        // ABIs (ç®€åŒ–ç‰ˆï¼ŒåªåŒ…å«éœ€è¦çš„å‡½æ•°)
        const MINTER_ABI = [
            "function buy(uint256 id, uint256 amount, address to) payable",
            "function priceWei(uint256 id) view returns (uint256)",
            "function whitelist(address user) view returns (bool)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function balanceOfBatch(address[] accounts, uint256[] ids) view returns (uint256[])"
        ];

        let provider, signer, userAddress;
        let minterContract, tokenContract;

        // è¿æ¥é’±åŒ…
        window.connectWallet = async function() {
            try {
                if (!window.ethereum) {
                    showMessage('è¯·å®‰è£… MetaMask!', 'error');
                    return;
                }

                // è¯·æ±‚è´¦æˆ·è®¿é—®
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== CONFIG.chainId) {
                    await switchNetwork();
                }

                // åˆå§‹åŒ–åˆçº¦
                minterContract = new ethers.Contract(CONFIG.contracts.Minter, MINTER_ABI, signer);
                tokenContract = new ethers.Contract(CONFIG.contracts.ExplorerToken, TOKEN_ABI, signer);

                // è·å– ETH ä½™é¢
                const balance = await provider.getBalance(userAddress);
                const ethBalance = ethers.formatEther(balance);

                // æ›´æ–° UI
                document.getElementById('connect-btn').style.display = 'none';
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('token-section').style.display = 'block';
                document.getElementById('address').textContent = userAddress;
                document.getElementById('eth-balance').textContent = parseFloat(ethBalance).toFixed(6);

                showMessage('é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');

                // åˆ·æ–°ä½™é¢
                await refreshBalances();

            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        };

        // åˆ‡æ¢ç½‘ç»œ
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.chainIdHex }],
                });
            } catch (error) {
                // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ ç½‘ç»œ
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CONFIG.chainIdHex,
                            chainName: 'OP Sepolia',
                            nativeCurrency: {
                                name: 'Ethereum',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: ['https://sepolia.optimism.io'],
                            blockExplorerUrls: ['https://sepolia-optimism.etherscan.io']
                        }]
                    });
                } else {
                    throw error;
                }
            }
        }

        // åˆ·æ–°ä½™é¢
        window.refreshBalances = async function() {
            try {
                const addresses = [userAddress, userAddress, userAddress];
                const ids = [CONFIG.tokenIds.POWER, CONFIG.tokenIds.OIL, CONFIG.tokenIds.EXPLORER];

                const balances = await tokenContract.balanceOfBatch(addresses, ids);

                document.getElementById('power-balance').textContent = balances[0].toString();
                document.getElementById('oil-balance').textContent = balances[1].toString();
                document.getElementById('explorer-balance').textContent = balances[2].toString();

                // æ£€æŸ¥ç™½åå•çŠ¶æ€
                const isWhitelisted = await minterContract.whitelist(userAddress);
                const whitelistEl = document.getElementById('whitelist-status');
                const explorerBtn = document.getElementById('explorer-buy-btn');

                if (isWhitelisted) {
                    whitelistEl.innerHTML = 'âœ… <span style="color: green;">æ‚¨åœ¨ç™½åå•ä¸­</span>';
                    explorerBtn.disabled = false;
                } else {
                    whitelistEl.innerHTML = 'âŒ <span style="color: red;">æ‚¨ä¸åœ¨ç™½åå•ä¸­</span>';
                    explorerBtn.disabled = true;
                }

                showMessage('ä½™é¢å·²åˆ·æ–°', 'success');
            } catch (error) {
                console.error(error);
                showMessage('åˆ·æ–°ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        };

        // è´­ä¹°ä»£å¸
        window.buyToken = async function(tokenId) {
            try {
                let amount, tokenName;

                if (tokenId === 1) {
                    amount = document.getElementById('power-amount').value;
                    tokenName = 'POWER';
                } else if (tokenId === 2) {
                    amount = document.getElementById('oil-amount').value;
                    tokenName = 'OIL';
                } else {
                    amount = document.getElementById('explorer-amount').value;
                    tokenName = 'EXPLORER';
                }

                if (!amount || amount < 1) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡', 'error');
                    return;
                }

                showMessage(`æ­£åœ¨è´­ä¹° ${amount} ä¸ª ${tokenName}...`, 'info');

                // è®¡ç®—æ€»ä»·
                const priceWei = BigInt(CONFIG.priceWei);
                const totalCost = priceWei * BigInt(amount);

                // å‘é€äº¤æ˜“
                const tx = await minterContract.buy(
                    tokenId,
                    amount,
                    userAddress,
                    { value: totalCost }
                );

                showMessage(`äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤... (TX: ${tx.hash.substring(0, 10)}...)`, 'info');

                // ç­‰å¾…ç¡®è®¤
                const receipt = await tx.wait();

                showMessage(`âœ… è´­ä¹°æˆåŠŸ! å·²è´­ä¹° ${amount} ä¸ª ${tokenName}`, 'success');

                // åˆ·æ–°ä½™é¢
                await refreshBalances();

            } catch (error) {
                console.error(error);
                let errorMsg = 'è´­ä¹°å¤±è´¥: ';

                if (error.message.includes('WalletCapExceeded')) {
                    errorMsg += 'è¶…å‡ºé’±åŒ…æŒæœ‰ä¸Šé™ (æ¯ç§ä»£å¸æœ€å¤š 1000 ä¸ª)';
                } else if (error.message.includes('NotWhitelisted')) {
                    errorMsg += 'æ‚¨ä¸åœ¨ç™½åå•ä¸­ï¼Œæ— æ³•è´­ä¹° EXPLORER';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg += 'ETH ä½™é¢ä¸è¶³';
                } else if (error.message.includes('user rejected')) {
                    errorMsg += 'æ‚¨å–æ¶ˆäº†äº¤æ˜“';
                } else {
                    errorMsg += error.message;
                }

                showMessage(errorMsg, 'error');
            }
        };

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = msg;
            messageDiv.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
